# KAERTEI 2025 FAIO - Production Docker Image
# Ubuntu 22.04 + ROS 2 Humble + Competition Dependencies
FROM ubuntu:22.04

# Environment setup
ENV DEBIAN_FRONTEND=noninteractive
ENV ROS_DISTRO=humble
ENV PYTHONUNBUFFERED=1
ENV LANG=en_US.UTF-8
ENV LC_ALL=en_US.UTF-8

# System locale setup
RUN apt-get update && apt-get install -y locales && \
    locale-gen en_US en_US.UTF-8 && \
    update-locale LC_ALL=en_US.UTF-8 LANG=en_US.UTF-8 && \
    rm -rf /var/lib/apt/lists/*

# Install ROS 2 Humble and essential dependencies
RUN apt-get update && apt-get install -y \
    # System essentials
    curl wget git build-essential cmake \
    lsb-release gnupg2 software-properties-common \
    # Python ecosystem
    python3 python3-pip python3-dev python3-venv \
    # ROS 2 and MAVROS dependencies
    python3-rosdep python3-colcon-common-extensions \
    # Hardware interface
    usbutils v4l-utils can-utils i2c-tools \
    python3-serial python3-usb \
    # Vision and math libraries
    libopencv-dev python3-opencv \
    python3-numpy python3-scipy python3-matplotlib \
    # Cleanup
    && rm -rf /var/lib/apt/lists/*

# Add ROS 2 repository and install
RUN curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg && \
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu $(lsb_release -cs) main" > /etc/apt/sources.list.d/ros2.list && \
    apt-get update && apt-get install -y \
    ros-humble-desktop \
    ros-humble-mavros \
    ros-humble-mavros-extras \
    && rm -rf /var/lib/apt/lists/*

# Install GeographicLib datasets for MAVROS
RUN /opt/ros/humble/lib/mavros/install_geographiclib_datasets.sh

# Create workspace
WORKDIR /workspace
RUN mkdir -p /workspace/kaertei2025

# Copy Python requirements and install
COPY requirements.txt /workspace/
RUN pip3 install --no-cache-dir -r /workspace/requirements.txt

# Install Just command runner
RUN curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin

# Setup ROS 2 environment
RUN echo "source /opt/ros/humble/setup.bash" >> ~/.bashrc

# Create entry script
RUN echo '#!/bin/bash\n\
source /opt/ros/humble/setup.bash\n\
cd /workspace/kaertei2025\n\
echo "🚁 KAERTEI 2025 FAIO Docker Environment"\n\
echo "===================================="\n\
echo "✅ ROS 2 Humble ready"\n\
echo "✅ MAVROS installed"\n\
echo "✅ Python dependencies ready"\n\
echo "✅ Just commands available"\n\
echo ""\n\
echo "Quick start:"\n\
echo "  just status    # Check system"\n\
echo "  just mission-debug  # Run mission"\n\
echo ""\n\
exec "$@"' > /entrypoint.sh && chmod +x /entrypoint.sh

# Set permissions for hardware access
RUN groupadd -g 20 dialout 2>/dev/null || true && \
    groupadd -g 44 video 2>/dev/null || true

ENTRYPOINT ["/entrypoint.sh"]
CMD ["/bin/bash"]
