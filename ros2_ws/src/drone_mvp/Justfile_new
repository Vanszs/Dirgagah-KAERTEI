# ========================================
# KAERTEI 2025 FAIO - Optimized Justfile
# Ubuntu 22.04 & Docker Commands
# ========================================

# Show available commands
default:
    @echo "ğŸš KAERTEI 2025 FAIO - Competition Ready System"
    @echo "=============================================="
    @echo ""
    @just --list

# ===================
# ğŸš€ ESSENTIAL COMMANDS
# ===================

# Complete Ubuntu 22.04 setup
setup:
    @echo "ğŸ”§ Setting up Ubuntu 22.04 for competition..."
    @./setup_ubuntu22.sh

# System health check
status:
    @echo "ğŸ“Š KAERTEI 2025 System Status"
    @echo "============================="
    @echo "ğŸ–¥ï¸  OS: $(lsb_release -d 2>/dev/null | cut -f2 || echo 'Unknown')"
    @echo "ğŸ Python: $(python3 --version 2>/dev/null || echo 'Not found')"
    @echo "ğŸ¤– ROS 2: $(test -f /opt/ros/humble/setup.bash && echo 'Humble âœ…' || echo 'Not installed âŒ')"
    @echo "ğŸ”§ Hardware: $(ls /dev/tty{ACM,USB}* 2>/dev/null | wc -l) device(s) detected"
    @echo "ğŸ“· Cameras: $(ls /dev/video* 2>/dev/null | wc -l) camera(s) detected"

# Complete system validation
test-all:
    @echo "ğŸ§ª Running comprehensive system tests..."
    @python3 validate_ubuntu22.py

# Hardware detection and testing
hardware-check:
    @echo "ğŸ” Hardware Detection & Testing"
    @echo "==============================="
    @echo "ğŸ“¡ Flight Controllers:"
    @ls /dev/tty{ACM,USB}* 2>/dev/null || echo "âŒ No flight controllers detected"
    @echo "ğŸ“· Cameras:"
    @v4l2-ctl --list-devices 2>/dev/null || echo "âŒ No cameras detected"
    @echo "ğŸ® GPIO Status:"
    @python3 -c "import RPi.GPIO; print('âœ… GPIO ready')" 2>/dev/null || echo "âš ï¸  GPIO not available (not on Raspberry Pi)"

# ===================
# ğŸ† COMPETITION COMMANDS
# ===================

# Debug mission (step-by-step with checkpoints)
mission-debug:
    @echo "ğŸš Starting debug mission (26 checkpoints)..."
    @./run_checkpoint_mission.sh debug

# Autonomous mission (full competition mode)
mission-auto:
    @echo "ğŸ¤– Starting autonomous competition mission..."
    @./run_checkpoint_mission.sh auto

# Competition readiness check
competition-ready:
    @echo "ğŸ† KAERTEI 2025 Competition Readiness Check"
    @echo "=========================================="
    @python3 validate_system.py --competition

# Emergency stop all processes
emergency-stop:
    @echo "ğŸš¨ Emergency stop - killing all drone processes..."
    @pkill -f "python3.*mission" || true
    @pkill -f "ros2" || true
    @echo "âœ… All processes stopped"

# ===================
# ğŸ³ DOCKER COMMANDS
# ===================

# Build Docker environment
docker-build:
    @echo "ğŸ³ Building Docker environment for KAERTEI 2025..."
    @docker-compose build

# Run Docker container
docker-run:
    @echo "ğŸ³ Running Docker container..."
    @docker-compose up -d
    @echo "âœ… Container started. Access with: docker exec -it kaertei2025_hexacopter bash"

# Docker mission debug
docker-mission:
    @echo "ğŸ³ Running mission in Docker..."
    @docker exec -it kaertei2025_hexacopter bash -c "source /opt/ros/humble/setup.bash && just mission-debug"

# Clean Docker resources
docker-clean:
    @echo "ğŸ³ Cleaning Docker resources..."
    @docker-compose down
    @docker system prune -f

# ===================
# ğŸ› ï¸ SYSTEM MAINTENANCE
# ===================

# Build ROS 2 workspace
build:
    @echo "ğŸ”¨ Building ROS 2 workspace..."
    @cd ../../.. && colcon build --packages-select drone_mvp

# Clean build files
clean:
    @echo "ğŸ§¹ Cleaning build files..."
    @cd ../../.. && rm -rf build/ install/ log/
    @echo "âœ… Build files cleaned"

# Install Just command runner
install-just:
    @echo "âš¡ Installing Just command runner..."
    @curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to ~/bin
    @echo 'export PATH="$HOME/bin:$PATH"' >> ~/.bashrc
    @echo "âœ… Just installed. Restart terminal or run: source ~/.bashrc"

# Update system and dependencies
update:
    @echo "ğŸ”„ Updating system and dependencies..."
    @sudo apt update && sudo apt upgrade -y
    @pip3 install --upgrade -r requirements.txt

# ===================
# ğŸ”§ HARDWARE SETUP
# ===================

# Test MAVROS connection
test-mavros:
    @echo "ğŸ“¡ Testing MAVROS connection..."
    @python3 -c "from pymavlink import mavutil; print('âœ… PyMAVLink ready')"

# Test camera system
test-cameras:
    @echo "ğŸ“· Testing camera system..."
    @python3 -c "import cv2; print('âœ… OpenCV ready')"

# Calibrate hardware
calibrate:
    @echo "âš–ï¸  Running hardware calibration..."
    @python3 calibrate_hardware.py

# Fix hardware permissions
fix-permissions:
    @echo "ğŸ”§ Fixing hardware permissions..."
    @sudo usermod -a -G dialout,video $USER
    @echo "âœ… Permissions fixed. Please logout and login again"

# ===================
# ğŸ“š HELP & INFO
# ===================

# Quick help for competition day
help:
    @echo "ğŸ† KAERTEI 2025 Competition Quick Commands"
    @echo "======================================="
    @echo "Setup:     just setup"
    @echo "Test:      just test-all"
    @echo "Mission:   just mission-debug"
    @echo "Status:    just status"
    @echo "Emergency: just emergency-stop"
    @echo ""
    @echo "Full list: just --list"

# System information
info:
    @echo "â„¹ï¸  KAERTEI 2025 FAIO System Information"
    @echo "====================================="
    @echo "Project: Autonomous Hexacopter Drone"
    @echo "Platform: Ubuntu 22.04 LTS + ROS 2 Humble"
    @echo "Mission: 26-Checkpoint Indoor/Outdoor"
    @echo "Repository: https://github.com/Vanszs/Dirgagah-KAERTEI"
