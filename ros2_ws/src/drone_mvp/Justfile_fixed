# ========================================
# KAERTEI 2025 FAIO - Optimized Justfile
# Universal Commands (Ubuntu/Docker)
# ========================================

# Show available commands
default:
    @echo "ğŸš KAERTEI 2025 FAIO - Competition Ready System"
    @echo "=============================================="
    @echo ""
    @echo "ğŸ¯ Quick Setup:"
    @echo "  just install     # Auto-detect & install everything"
    @echo "  just test        # Validate system"
    @echo "  just mission     # Start competition mission"
    @echo ""
    @just --list

# ===================
# ğŸš€ INSTALLATION
# ===================

# Universal auto-detect installer
install:
    @echo "ğŸš€ Starting KAERTEI 2025 auto-installer..."
    @chmod +x install_kaertei.sh
    @./install_kaertei.sh

# Legacy Ubuntu 22.04 setup (deprecated)
setup-ubuntu:
    @echo "âš ï¸  Using legacy installer..."
    @echo "ğŸ’¡ Recommended: just install (auto-detect)"
    @./setup_ubuntu22_legacy.sh

# ===================
# ğŸ† MISSION COMMANDS
# ===================

# Competition mission (auto-detect Docker/Ubuntu)
mission:
    #!/usr/bin/env bash
    if command -v docker >/dev/null && docker ps >/dev/null 2>&1; then
        echo "ğŸ³ Docker detected - running in container"
        just docker-mission
    else
        echo "ğŸ–¥ï¸  Ubuntu detected - running natively"
        just ubuntu-mission
    fi

# Ubuntu native mission
ubuntu-mission:
    @echo "ğŸš Starting mission on Ubuntu (native)..."
    @if [ ! -d "../../../install" ]; then echo "ğŸ”¨ Building workspace first..."; just build; fi
    @./run_checkpoint_mission.sh debug

# Docker containerized mission
docker-mission:
    @echo "ğŸ³ Starting mission in Docker container..."
    @docker exec -it kaertei2025_hexacopter bash -c "source /opt/ros/humble/setup.bash && ./run_checkpoint_mission.sh debug"

# Debug mission (step-by-step with checkpoints)
mission-debug:
    @echo "ğŸ” Debug mission (26 checkpoints step-by-step)..."
    @./run_checkpoint_mission.sh debug

# Autonomous mission (full competition mode)
mission-auto:
    @echo "ğŸ¤– Autonomous competition mission..."
    @./run_checkpoint_mission.sh auto

# ===================
# ğŸ§ª TESTING & STATUS
# ===================

# Quick system test (auto-detect environment)
test:
    #!/usr/bin/env bash
    if command -v docker >/dev/null && docker ps >/dev/null 2>&1; then
        echo "ğŸ³ Testing Docker environment..."
        just docker-test
    else
        echo "ğŸ–¥ï¸  Testing Ubuntu environment..."
        just ubuntu-test
    fi

# Complete Ubuntu system validation
ubuntu-test:
    @echo "ğŸ§ª Ubuntu system validation..."
    @python3 validate_ubuntu22.py

# Docker container test
docker-test:
    @echo "ğŸ³ Docker container validation..."
    @docker exec -it kaertei2025_hexacopter python3 validate_ubuntu22.py

# System status (universal)
status:
    @echo "ğŸ“Š KAERTEI 2025 System Status"
    @echo "============================="
    @echo "ğŸ–¥ï¸  OS: $(lsb_release -d 2>/dev/null | cut -f2 || echo 'Unknown')"
    @echo "ğŸ—ï¸  Arch: $(uname -m)"
    @echo "ğŸ Python: $(python3 --version 2>/dev/null || echo 'Not found')"
    @echo "ğŸ¤– ROS 2: $(test -f /opt/ros/humble/setup.bash && echo 'Humble âœ…' || echo 'Not installed âŒ')"
    @echo "ğŸ³ Docker: $(command -v docker >/dev/null && echo 'Available âœ…' || echo 'Not installed âŒ')"
    @echo "ğŸ”§ Hardware: $(ls /dev/tty{ACM,USB}* 2>/dev/null | wc -l) device(s)"
    @echo "ğŸ“· Cameras: $(ls /dev/video* 2>/dev/null | wc -l) camera(s)"
    @echo "ğŸ“ Raspberry Pi: $([ -f /proc/cpuinfo ] && grep -q "Raspberry Pi" /proc/cpuinfo && echo 'Yes âœ…' || echo 'No')"

# Hardware detection
hardware:
    @echo "ğŸ” Hardware Detection"
    @echo "===================="
    @echo "ğŸ“¡ Flight Controllers:"
    @ls /dev/tty{ACM,USB}* 2>/dev/null || echo "âŒ No flight controllers detected"
    @echo ""
    @echo "ğŸ“· Cameras:"
    @v4l2-ctl --list-devices 2>/dev/null || echo "âŒ No cameras detected" 
    @echo ""
    @echo "ğŸ® GPIO (Raspberry Pi):"
    @python3 -c "import RPi.GPIO; print('âœ… GPIO ready')" 2>/dev/null || echo "âš ï¸  Not on Raspberry Pi or GPIO unavailable"

# ===================
# ğŸ³ DOCKER COMMANDS
# ===================

# Build Docker image
docker-build:
    @echo "ğŸ³ Building KAERTEI Docker image..."
    @docker-compose build --no-cache

# Start Docker container
docker-start:
    @echo "ğŸ³ Starting KAERTEI container..."
    @docker-compose up -d
    @echo "âœ… Container ready. Access: docker exec -it kaertei2025_hexacopter bash"

# Stop Docker container
docker-stop:
    @echo "ğŸ³ Stopping KAERTEI container..."
    @docker-compose down

# Enter Docker container
docker-shell:
    @echo "ğŸ³ Entering container shell..."
    @docker exec -it kaertei2025_hexacopter bash

# Clean Docker resources
docker-clean:
    @echo "ğŸ³ Cleaning Docker resources..."
    @docker-compose down --volumes
    @docker system prune -f
    @echo "âœ… Docker resources cleaned"

# ===================
# ğŸ› ï¸ DEVELOPMENT
# ===================

# Build ROS 2 workspace
build:
    @echo "ğŸ”¨ Building ROS 2 workspace..."
    @cd ../../.. && colcon build --packages-select drone_mvp

# Clean build files
clean:
    @echo "ğŸ§¹ Cleaning build files..."
    @cd ../../.. && rm -rf build/ install/ log/
    @echo "âœ… Build files cleaned"

# Update system and dependencies
update:
    @echo "ğŸ”„ Updating system..."
    @sudo apt update && sudo apt upgrade -y
    @pip3 install --upgrade -r requirements.txt

# ===================
# ğŸ†˜ EMERGENCY
# ===================

# Emergency stop all processes
stop:
    @echo "ğŸš¨ Emergency stop - killing all processes..."
    @pkill -f "python3.*mission" || true
    @pkill -f "ros2" || true
    @pkill -f "mavros" || true
    @echo "âœ… All processes stopped"

# Competition day emergency reset
emergency:
    @echo "ğŸ†˜ Competition Emergency Reset"
    @echo "============================="
    @pkill -f ros2 || true
    @pkill -f mavros || true
    @pkill -f python3 || true
    @sudo rmmod usbserial || true
    @sudo modprobe usbserial || true
    @sudo chmod 666 /dev/tty{USB,ACM}* 2>/dev/null || true
    @ros2 daemon stop || true
    @ros2 daemon start || true
    @echo "âœ… Emergency reset completed"
    @echo "ğŸš€ Run: just mission"

# ===================
# ğŸ“š HELP & INFO
# ===================

# Competition quick help
help:
    @echo "ğŸ† KAERTEI 2025 - Competition Quick Guide"
    @echo "======================================="
    @echo ""
    @echo "ğŸš€ Setup (first time):"
    @echo "  just install"
    @echo ""
    @echo "ğŸ¯ Competition Day:"
    @echo "  just test        # Validate system"
    @echo "  just hardware    # Check hardware"
    @echo "  just mission     # Start competition"
    @echo "  just stop        # Emergency stop"
    @echo ""
    @echo "ğŸ³ Docker Mode:"
    @echo "  just docker-build    # Build container"
    @echo "  just docker-start    # Start container"  
    @echo "  just docker-mission  # Run in container"
    @echo ""
    @echo "Full commands: just --list"

# System information
info:
    @echo "â„¹ï¸  KAERTEI 2025 FAIO System"
    @echo "=========================="
    @echo "Project: Autonomous Hexacopter"
    @echo "Platform: Ubuntu 22.04 + ROS 2 Humble"
    @echo "Mission: 26-Checkpoint Competition"
    @echo "Hardware: Pixhawk + Multi-Camera + GPIO"
    @echo "Modes: Ubuntu Native / Docker Container"
    @echo "Repository: github.com/Vanszs/Dirgagah-KAERTEI"
